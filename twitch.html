<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Twitch AI TTS Extension</title>
  <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
</head>
<body style="background: transparent; text-align: center;">

  <h1 style="font-size:18px;">TTS Extension Active</h1>

  <input type="text" id="textInput" placeholder="Type your message..." style="margin-top:20px; width:80%;">
  <br><br>

  <select id="voiceSelect" style="margin-bottom:20px;">
    <optgroup label="OpenAI Voices">
      <option value="openai-nova">Nova (neutral female)</option>
      <option value="openai-echo">Echo (deep male)</option>
      <option value="openai-onyx">Onyx (calm male)</option>
      <option value="openai-fable">Fable (storyteller)</option>
    </optgroup>
    <optgroup label="ElevenLabs Voices">
      <option value="elevenlabs-default">Premium Emotional Voice</option>
    </optgroup>
  </select>
  <br>

  <button id="buySpeakButton" style="padding:10px 20px; font-size:16px;">Buy TTS (10 Bits)</button>

  <audio id="audioPlayer" controls style="margin-top:20px;"></audio>

  <script>
    let authToken = "";
    let userId = "";
    let currentTransaction = null;

    window.Twitch.ext.onAuthorized(function(auth) {
      authToken = auth.token;
      userId = auth.userId;
      console.log("Authorized as", userId);
    });

    document.getElementById('buySpeakButton').onclick = function() {
      const text = document.getElementById('textInput').value.trim();
      const voice = document.getElementById('voiceSelect').value;

      if (!text) {
        alert('Please enter a message first.');
        return;
      }

      currentTransaction = { text, voice };
      Twitch.ext.bits.useBits('sku_tts_10bits');
    };

    Twitch.ext.bits.onTransactionComplete((transaction) => {
      console.log("Bits transaction complete", transaction);
      if (currentTransaction) {
        triggerTTS(currentTransaction.text, currentTransaction.voice);
        currentTransaction = null;
      }
    });

    async function triggerTTS(text, voice) {
      const response = await fetch('https://0u3vlbr0qr2kvds940tgz9oi1m1gca.ext-twitch.tv/speak', {

        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text, voice })
      });

      if (response.ok) {
        const blob = await response.blob();
        const audioUrl = URL.createObjectURL(blob);
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.src = audioUrl;
        audioPlayer.play();
      } else {
        console.error("TTS failed");
      }
    }
  </script>

</body>
</html>
